<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Browse Care Providers - Crossing Sunsets‚Ñ¢</title>

  <!-- Google Translate -->
  <script>
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,es,zh-CN,fr,de,it,pt,ru,ja,ko,ar',
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      }, 'google_translate_element');
    }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; line-height:1.6; color:#333; background:#f5f7fa; }
    #google_translate_element{ position:fixed; top:70px; right:10px; z-index:9999; background:#fff; padding:5px 10px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.2); }

    nav{ background:linear-gradient(135deg,#00bcd4 0%,#0097a7 100%); padding:1rem 2rem; box-shadow:0 2px 10px rgba(0,0,0,.1); position:sticky; top:0; z-index:1000; }
    nav .container{ max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
    .logo-section{ display:flex; align-items:center; gap:15px; }
    .logo-section img{ width:50px; height:50px; border-radius:10px; }
    .logo-section h1{ color:#fff; font-size:24px; }
    nav ul{ list-style:none; display:flex; gap:2rem; }
    nav a{ color:#fff; text-decoration:none; font-weight:500; transition:opacity .3s; }
    nav a:hover{ opacity:.8; }

    .main-content{ max-width:1200px; margin:40px auto; padding:0 20px; }
    .page-header{ text-align:center; margin-bottom:40px; }
    .page-header h2{ color:#2c3e50; font-size:2.5rem; margin-bottom:10px; }
    .page-header p{ color:#7f8c8d; font-size:1.1rem; }

    .bed-stats-banner{ display:none; grid-template-columns:repeat(3,1fr); gap:20px; margin-bottom:30px; padding:20px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .stat-item{ text-align:center; padding:15px; border-right:1px solid #E0E0E0; }
    .stat-item:last-child{ border-right:none; }
    .stat-number{ display:block; font-size:32px; font-weight:700; color:#00ACC1; margin-bottom:5px; }
    .stat-label{ display:block; font-size:14px; color:#666; text-transform:uppercase; letter-spacing:.5px; }

    .filter-section{ background:#fff; padding:25px; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,.1); margin-bottom:20px; }
    .filter-label{ color:#2c3e50; font-weight:600; margin-bottom:15px; display:block; font-size:1.1rem; }
    .filter-buttons{ display:flex; gap:10px; flex-wrap:wrap; }
    .filter-btn{ padding:10px 20px; border:2px solid #00bcd4; background:#fff; color:#00bcd4; border-radius:25px; cursor:pointer; font-weight:600; transition:all .3s; font-size:14px; }
    .filter-btn:hover{ background:#e0f7fa; }
    .filter-btn.active{ background:#00bcd4; color:#fff; }

    .search-box{ background:#fff; padding:30px; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,.1); margin-bottom:40px; }
    .search-box input{ width:100%; padding:15px; border:2px solid #e0e0e0; border-radius:10px; font-size:16px; transition:border-color .3s; }
    .search-box input:focus{ outline:none; border-color:#00bcd4; }

    .providers-grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:30px; }
    .provider-card{ background:#fff; border-radius:15px; overflow:hidden; box-shadow:0 5px 20px rgba(0,0,0,.1); transition:transform .3s; }
    .provider-card:hover{ transform:translateY(-10px); }
    .provider-header{ background:linear-gradient(135deg,#00bcd4 0%,#0097a7 100%); padding:20px; text-align:center; }
    .provider-logo{ width:80px; height:80px; border-radius:50%; background:#fff; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; font-size:2.5rem; }
    .provider-header h3{ color:#fff; font-size:1.5rem; margin-bottom:5px; }
    .provider-header .location{ color:rgba(255,255,255,.9); font-size:.9rem; }
    .provider-body{ padding:25px; }
    .provider-type-badge{ display:inline-block; background:#e0f7fa; color:#00838f; padding:5px 15px; border-radius:15px; font-size:.85rem; font-weight:600; margin-bottom:15px; }
    .provider-description{ color:#666; font-size:.95rem; line-height:1.6; margin-bottom:20px; min-height:60px; }
    .provider-info{ margin-bottom:20px; }
    .info-item{ display:flex; align-items:flex-start; margin-bottom:12px; color:#555; }
    .info-icon{ margin-right:10px; color:#00bcd4; }

    .bed-availability{ margin:15px 0; padding:12px 16px; background:#E8F5E9; border-radius:8px; display:flex; align-items:center; font-weight:600; color:#2E7D32; font-size:16px; }
    .bed-availability.low{ background:#FFF3E0; color:#E65100; }
    .bed-icon{ margin-right:10px; font-size:20px; }

    .provider-actions{ display:flex; gap:10px; }
    .btn{ flex:1; padding:12px; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:all .3s; text-align:center; text-decoration:none; display:inline-block; }
    .btn-reviews{ background:#ff6b35; color:#fff; }
    .btn-reviews:hover{ background:#e55a2b; transform:translateY(-2px); }
    .btn-review{ background:transparent; color:#00bcd4; border:2px solid #00bcd4; }
    .btn-review:hover{ background:#00bcd4; color:#fff; }

    .no-results{ text-align:center; padding:60px 20px; background:#fff; border-radius:15px; box-shadow:0 5px 20px rgba(0,0,0,.1); }
    .no-results p{ color:#7f8c8d; font-size:1.2rem; }

    footer{ background:#2c3e50; color:#fff; padding:40px 20px; text-align:center; margin-top:60px; }
    footer .footer-links{ display:flex; justify-content:center; gap:2rem; margin-bottom:20px; flex-wrap:wrap; }
    footer a{ color:#fff; text-decoration:none; transition:color .3s; }
    footer a:hover{ color:#00bcd4; }
    footer .contact-info{ margin-top:20px; font-size:.9rem; }
    footer .contact-info a{ color:#00bcd4; }

    @media (max-width:768px){
      nav ul{ flex-direction:column; gap:1rem; }
      .providers-grid{ grid-template-columns:1fr; }
      .page-header h2{ font-size:2rem; }
      .filter-buttons{ justify-content:center; }
      .bed-stats-banner{ grid-template-columns:1fr; }
      .stat-item{ border-right:none; border-bottom:1px solid #E0E0E0; }
      .stat-item:last-child{ border-bottom:none; }
    }
  </style>
</head>
<body>
  <div id="google_translate_element"></div>

  <nav>
    <div class="container">
      <div class="logo-section">
        <img src="crossing-sunsets-logo.png" alt="Crossing Sunsets Logo"/>
        <h1>Crossing Sunsets‚Ñ¢</h1>
      </div>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="browse-providers.html">Browse Providers</a></li>
        <li><a href="quick-signup.html">Leave a Review</a></li>
      </ul>
    </div>
  </nav>

  <div class="main-content">
    <div class="page-header">
      <h2>Browse Care Providers</h2>
      <p>Find compassionate hospice, palliative care, skilled nursing, boarding homes, and memory care in your area</p>
    </div>

    <!-- Live Bed Statistics (shown only for Skilled Nursing) -->
    <div id="bed-stats-banner" class="bed-stats-banner">
      <div class="stat-item"><span id="stat-available" class="stat-number">0</span><span class="stat-label">Beds Available</span></div>
      <div class="stat-item"><span id="stat-facilities" class="stat-number">0</span><span class="stat-label">Facilities</span></div>
      <div class="stat-item"><span id="stat-total" class="stat-number">0</span><span class="stat-label">Total Beds</span></div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
      <span class="filter-label">üè• Filter by Type of Care:</span>
      <div class="filter-buttons">
        <button class="filter-btn active" data-cat="all">All Providers</button>
        <button class="filter-btn" data-cat="hospice">üè• Hospice</button>
        <button class="filter-btn" data-cat="palliative">üíô Palliative Care</button>
        <button class="filter-btn" data-cat="skilled-nursing">üè® Skilled Nursing</button>
        <button class="filter-btn" data-cat="board-and-care-facilities">üè° Board and Care Facilities</button>
        <button class="filter-btn" data-cat="memory-care">üß† Memory Care</button>
      </div>
    </div>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="üîç Search by city, state, or provider name...">
    </div>

    <div class="providers-grid" id="providersGrid"></div>

    <div id="noResults" class="no-results" style="display:none;">
      <p>No providers found matching your search. Try a different search term or filter.</p>
    </div>
  </div>

  <footer>
    <div class="footer-links">
      <a href="index.html">Home</a>
      <a href="browse-providers.html">Browse Providers</a>
      <a href="choose-plan.html">üîí For Healthcare Providers</a>
      <a href="privacy.html">Privacy</a>
      <a href="mailto:support@crossingsunsets.app">üìß Contact Us</a>
    </div>
    <p>&copy; 2025 Crossing Sunsets‚Ñ¢. All rights reserved.</p>
    <div class="contact-info">
      üí¨ Support: <a href="mailto:support@crossingsunsets.app">support@crossingsunsets.app</a> |
      <a href="mailto:eduardo@crossingsunsets.app">eduardo@crossingsunsets.app</a>
    </div>
  </footer>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // --- Firebase config (kept from your page) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB410YcmXKj09W82ck6tZ2WYhyLdyZWtEQ",
      authDomain: "crossing-sunsets.firebaseapp.com",
      databaseURL: "https://crossing-sunsets-default-rtdb.firebaseio.com",
      projectId: "crossing-sunsets",
      storageBucket: "crossing-sunsets.firebasestorage.app",
      messagingSenderId: "83761464492",
      appId: "1:83761464492:web:9e05d8af5a45fe1ff38b09",
      measurementId: "G-LG8VN0EZB7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ------- UI State -------
    let currentFilter = 'all';
    let lastSnapshotData = []; // cache docs for search/filter without re-query

    // Helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function getCategoryFromProvider(p){
      const t = (p.providerType || p.careType || '').toLowerCase();
      if (t.includes('skilled') || t === 'skilled_nursing') return 'skilled-nursing';
      if (t.includes('memory')) return 'memory-care';
      if (t.includes('board')) return 'board-and-care-facilities';
      if (t.includes('palliative')) return 'palliative';
      return 'hospice';
    }
    function getCategoryIcon(cat){
      return ({'hospice':'üè•','skilled-nursing':'üè®','memory-care':'üß†','board-and-care-facilities':'üè°','palliative':'üíô'})[cat] || 'üè•';
    }
    function getCategoryName(cat){
      return ({'hospice':'Hospice Care','skilled-nursing':'Skilled Nursing','memory-care':'Memory Care','board-and-care-facilities':'Board and Care Facilities','palliative':'Palliative Care'})[cat] || 'Healthcare Provider';
    }

    function providerDisplayName(p){ return p.businessName || p.name || 'Provider'; }
    function providerLocation(p){
      return p.serviceAreaLabel || p.serviceArea || (p.city && p.state ? `${p.city}, ${p.state}` : 'Location not specified');
    }

    function normalizeSearchTokens(p){
      const name = providerDisplayName(p).toLowerCase();
      const loc = providerLocation(p).toLowerCase();
      return { name, loc };
    }

    function bedHTMLFor(cat, beds){
      if (cat !== 'skilled-nursing') return '';
      if (!beds) return '';
      const { total = 0, available = 0 } = beds;
      const low = Number(available) < 10;
      return `
        <div class="bed-availability ${low ? 'low':''}">
          <span class="bed-icon">üõèÔ∏è</span>
          <span>${available} / ${total} Beds Available</span>
        </div>`;
    }

    function makeCard(p, id, beds){
      const cat = getCategoryFromProvider(p);
      const name = providerDisplayName(p);
      const loc = providerLocation(p);
      const email = p.email || '';
      const website = p.website || '';

      const card = document.createElement('div');
      card.className = 'provider-card';
      card.dataset.firebaseId = id;
      card.dataset.category = cat;

      const tokens = normalizeSearchTokens(p);
      card.dataset.name = tokens.name.replace(/\s+/g,'-');
      card.dataset.location = tokens.loc;

      card.innerHTML = `
        <div class="provider-header">
          <div class="provider-logo">${p.logo || getCategoryIcon(cat)}</div>
          <h3>${name}</h3>
          <div class="location">üìç ${loc}</div>
        </div>
        <div class="provider-body">
          <span class="provider-type-badge">${getCategoryIcon(cat)} ${getCategoryName(cat)}</span>
          <div class="provider-description">
            ${p.description || 'Quality care services for your loved ones.'}
          </div>
          <div class="provider-info">
            ${p.contactName ? `
            <div class="info-item">
              <span class="info-icon">üë§</span>
              <span><strong>Contact:</strong> ${p.contactName}</span>
            </div>` : ''}

            ${email ? `
            <div class="info-item">
              <span class="info-icon">üìß</span>
              <span><strong>Email:</strong> <a href="mailto:${email}" style="color:#00bcd4;">${email}</a></span>
            </div>` : ''}

            ${website ? `
            <div class="info-item">
              <span class="info-icon">üåê</span>
              <span><strong>Website:</strong> <a href="${website}" target="_blank" style="color:#00bcd4;">${website}</a></span>
            </div>` : ''}
          </div>

          ${bedHTMLFor(cat, beds)}

          <div class="provider-actions">
            <a href="#" class="btn btn-reviews">üìñ Read Reviews</a>
            <a href="quick-signup.html?provider=${encodeURIComponent(id)}" class="btn btn-review">‚úçÔ∏è Leave a Review</a>
          </div>
        </div>
      `;
      return card;
    }

    // Calculate and render Skilled Nursing stats
    function renderStats(docs){
      if (currentFilter !== 'skilled-nursing'){ $('#bed-stats-banner').style.display = 'none'; return; }

      let fac = 0, total = 0, available = 0;
      docs.forEach(({p,beds})=>{
        const cat = getCategoryFromProvider(p);
        if (cat === 'skilled-nursing'){
          fac += 1;
          if (beds){ total += Number(beds.total||0); available += Number(beds.available||0); }
          else {
            total += Number(p.totalBeds||0);
            available += Number(p.availableBeds||0);
          }
        }
      });
      $('#stat-facilities').textContent = fac;
      $('#stat-total').textContent = total;
      $('#stat-available').textContent = available;
      $('#bed-stats-banner').style.display = 'grid';
    }

    // Fetch providers and bed subdocs, then render
    async function loadProviders(){
      // Query only approved providers
      const snap = await db.collection('providers').where('status','==','approved').get();
      const items = [];

      for (const doc of snap.docs){
        const p = doc.data() || {};
        const id = doc.id;

        // Try subdoc first
        let beds = null;
        try {
          const b = await db.collection('providers').doc(id).collection('status').doc('beds').get();
          if (b.exists) beds = b.data();
        } catch(e){ /* ignore */ }

        // Fallback to top-level mirrors
        if (!beds && (p.totalBeds || p.availableBeds)){
          beds = {
            total: Number(p.totalBeds||0),
            available: Number(p.availableBeds||0),
            occupied: Number(p.occupiedBeds||Math.max(0, (p.totalBeds||0)-(p.availableBeds||0)))
          };
        }

        items.push({ id, p, beds });
      }

      lastSnapshotData = items;
      renderList();
    }

    function renderList(){
      const grid = $('#providersGrid');
      grid.innerHTML = ''; // clear

      const searchTerm = ($('#searchInput').value||'').toLowerCase();
      let visible = 0;

      lastSnapshotData.forEach(({id,p,beds})=>{
        const cat = getCategoryFromProvider(p);
        const tokens = normalizeSearchTokens(p);
        const matchesFilter = (currentFilter === 'all' || cat === currentFilter);
        const matchesSearch = (!searchTerm || tokens.name.includes(searchTerm) || tokens.loc.includes(searchTerm));
        if (matchesFilter && matchesSearch){
          grid.appendChild(makeCard(p,id,beds));
          visible++;
        }
      });

      $('#noResults').style.display = visible ? 'none' : 'block';
      renderStats(lastSnapshotData);
    }

    // Events: filter buttons + search
    document.addEventListener('DOMContentLoaded', ()=>{
      // Filter buttons
      $$('.filter-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          $$('.filter-btn').forEach(b=>b.classList.remove('active'));
          e.currentTarget.classList.add('active');
          currentFilter = e.currentTarget.dataset.cat;
          renderList();
        });
      });

      // Search
      $('#searchInput').addEventListener('input', renderList);

      // Load data
      loadProviders();
    });
  </script>
</body>
</html>
