<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Care Providers - Crossing Sunsets‚Ñ¢</title>
    <!-- Google Translate -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,es,zh-CN,fr,de,it,pt,ru,ja,ko,ar',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; background: #f5f7fa; }
        #google_translate_element { position: fixed; top: 70px; right: 10px; z-index: 9999; background: white; padding: 5px 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        nav { background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); padding: 1rem 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        nav .container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo-section { display: flex; align-items: center; gap: 15px; }
        .logo-section img { width: 50px; height: 50px; border-radius: 10px; }
        .logo-section h1 { color: white; font-size: 24px; }
        nav ul { list-style: none; display: flex; gap: 2rem; }
        nav a { color: white; text-decoration: none; font-weight: 500; transition: opacity 0.3s; }
        nav a:hover { opacity: 0.8; }

        .main-content { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .page-header { text-align: center; margin-bottom: 40px; }
        .page-header h2 { color: #2c3e50; font-size: 2.5rem; margin-bottom: 10px; }
        .page-header p { color: #7f8c8d; font-size: 1.1rem; }

        /* Bed Stats Banner */
        .bed-stats-banner { display: none; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .stat-item { text-align: center; padding: 15px; border-right: 1px solid #E0E0E0; }
        .stat-item:last-child { border-right: none; }
        .stat-number { display: block; font-size: 32px; font-weight: 700; color: #00ACC1; margin-bottom: 5px; }
        .stat-label { display: block; font-size: 14px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Filter Buttons */
        .filter-section { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .filter-label { color: #2c3e50; font-weight: 600; margin-bottom: 15px; display: block; font-size: 1.1rem; }
        .filter-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 10px 20px; border: 2px solid #00bcd4; background: white; color: #00bcd4; border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 14px; }
        .filter-btn:hover { background: #e0f7fa; }
        .filter-btn.active { background: #00bcd4; color: white; }

        .search-box { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 40px; }
        .search-box input { width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        .search-box input:focus { outline: none; border-color: #00bcd4; }

        .providers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; }
        .provider-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transition: transform 0.3s; }
        .provider-card:hover { transform: translateY(-10px); }
        .provider-header { background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%); padding: 20px; text-align: center; }
        .provider-logo { width: 80px; height: 80px; border-radius: 50%; background: white; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; }
        .provider-header h3 { color: white; font-size: 1.5rem; margin-bottom: 5px; }
        .provider-header .location { color: rgba(255,255,255,0.9); font-size: 0.9rem; }
        .provider-body { padding: 25px; }

        .provider-type-badge { display: inline-block; background: #e0f7fa; color: #00838f; padding: 5px 15px; border-radius: 15px; font-size: 0.85rem; font-weight: 600; margin-bottom: 15px; }
        .provider-description { color: #666; font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px; min-height: 60px; }

        /* Bed Availability Display */
        .bed-availability { margin: 15px 0; padding: 12px 16px; background: #E8F5E9; border-radius: 8px; display: flex; align-items: center; font-weight: 600; color: #2E7D32; font-size: 16px; }
        .bed-availability.low { background: #FFF3E0; color: #E65100; }
        .bed-icon { margin-right: 10px; font-size: 20px; }

        .provider-actions { display: flex; gap: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-align: center; text-decoration: none; display: inline-block; }
        .btn-reviews { background: #ff6b35; color: white; }
        .btn-reviews:hover { background: #e55a2b; transform: translateY(-2px); }
        .btn-review { background: transparent; color: #00bcd4; border: 2px solid #00bcd4; }
        .btn-review:hover { background: #00bcd4; color: white; }

        .no-results { text-align: center; padding: 60px 20px; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .no-results p { color: #7f8c8d; font-size: 1.2rem; }

        footer { background: #2c3e50; color: white; padding: 40px 20px; text-align: center; margin-top: 60px; }
        footer .footer-links { display: flex; justify-content: center; gap: 2rem; margin-bottom: 20px; flex-wrap: wrap; }
        footer a { color: white; text-decoration: none; transition: color 0.3s; }
        footer a:hover { color: #00bcd4; }
        footer .contact-info { margin-top: 20px; font-size: 0.9rem; }
        footer .contact-info a { color: #00bcd4; }

        @media (max-width: 768px) {
            nav ul { flex-direction: column; gap: 1rem; }
            .providers-grid { grid-template-columns: 1fr; }
            .page-header h2 { font-size: 2rem; }
            .filter-buttons { justify-content: center; }
            .bed-stats-banner { grid-template-columns: 1fr; }
            .stat-item { border-right: none; border-bottom: 1px solid #E0E0E0; }
            .stat-item:last-child { border-bottom: none; }
        }
    </style>
</head>
<body>
    <div id="google_translate_element"></div>

    <nav>
        <div class="container">
            <div class="logo-section">
                <img src="crossing-sunsets-logo.png" alt="Crossing Sunsets Logo">
                <h1>Crossing Sunsets‚Ñ¢</h1>
            </div>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="browse-providers.html">Browse Providers</a></li>
                <li><a href="quick-signup.html">Leave a Review</a></li>
            </ul>
        </div>
    </nav>

    <div class="main-content">
        <div class="page-header">
            <h2>Browse Care Providers</h2>
            <p>Find compassionate hospice, palliative care, skilled nursing, boarding homes, and memory care in your area</p>
        </div>

        <!-- LIVE Bed Statistics Banner (Skilled Nursing totals) -->
        <div id="bed-stats-banner" class="bed-stats-banner">
            <div class="stat-item">
                <span id="bedsAvailableTotal" class="stat-number">0</span>
                <span class="stat-label">Beds Available</span>
            </div>
            <div class="stat-item">
                <span id="facilitiesCount" class="stat-number">0</span>
                <span class="stat-label">Facilities</span>
            </div>
            <div class="stat-item">
                <span id="bedsTotal" class="stat-number">0</span>
                <span class="stat-label">Total Beds</span>
            </div>
        </div>

        <!-- Filter Buttons -->
        <div class="filter-section">
            <span class="filter-label">üè• Filter by Type of Care:</span>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterProviders('all', this)">All Providers</button>
                <button class="filter-btn" onclick="filterProviders('hospice', this)">üè• Hospice</button>
                <button class="filter-btn" onclick="filterProviders('palliative', this)">üíô Palliative Care</button>
                <button class="filter-btn" onclick="filterProviders('skilled-nursing', this)">üè® Skilled Nursing</button>
                <button class="filter-btn" onclick="filterProviders('board-and-care-facilities', this)">üè° Board and Care Facilities</button>
                <button class="filter-btn" onclick="filterProviders('memory-care', this)">üß† Memory Care</button>
            </div>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="üîç Search by city, state, or provider name..." onkeyup="searchProviders()">
        </div>

        <div class="providers-grid" id="providersGrid">
            <!-- Example static card (optional) -->
            <!-- Firestore providers will be added here dynamically -->
        </div>

        <div id="noResults" class="no-results" style="display: none;">
            <p>No providers found matching your search. Try a different search term or filter.</p>
        </div>
    </div>

    <footer>
        <div class="footer-links">
            <a href="index.html">Home</a>
            <a href="browse-providers.html">Browse Providers</a>
            <a href="choose-plan.html">üîí For Healthcare Providers</a>
            <a href="privacy.html">Privacy</a>
            <a href="mailto:support@crossingsunsets.app">üìß Contact Us</a>
        </div>
        <p>&copy; 2025 Crossing Sunsets‚Ñ¢. All rights reserved.</p>
        <div class="contact-info">
            üí¨ Support: <a href="mailto:support@crossingsunsets.app">support@crossingsunsets.app</a> |
            <a href="mailto:eduardo@crossingsunsets.app">eduardo@crossingsunsets.app</a>
        </div>
    </footer>

    <script>
        let currentFilter = 'all';

        function filterProviders(category, btnEl) {
            currentFilter = category;

            // Update active button (no reliance on event.target)
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');

            // Show/hide bed stats banner for Skilled Nursing
            const statsBanner = document.getElementById('bed-stats-banner');
            statsBanner.style.display = (category === 'skilled-nursing') ? 'grid' : 'none';

            // Filter cards
            const cards = document.querySelectorAll('.provider-card');
            let visibleCount = 0;
            cards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                if (category === 'all' || cardCategory === category) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show/hide no results
            document.getElementById('noResults').style.display = (visibleCount === 0) ? 'block' : 'none';
        }

        function searchProviders() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.provider-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const name = (card.getAttribute('data-name') || '').toLowerCase();
                const location = (card.getAttribute('data-location') || '').toLowerCase();
                const cardCategory = card.getAttribute('data-category');

                const matchesFilter = (currentFilter === 'all' || cardCategory === currentFilter);
                const matchesSearch = (name.includes(searchTerm) || location.includes(searchTerm));

                if (matchesFilter && matchesSearch) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            document.getElementById('noResults').style.display = (visibleCount === 0) ? 'block' : 'none';
        }
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB410YcmXKj09W82ck6tZ2WYhyLdyZWtEQ",
            authDomain: "crossing-sunsets.firebaseapp.com",
            databaseURL: "https://crossing-sunsets-default-rtdb.firebaseio.com",
            projectId: "crossing-sunsets",
            storageBucket: "crossing-sunsets.firebasestorage.app",
            messagingSenderId: "83761464492",
            appId: "1:83761464492:web:9e05d8af5a45fe1ff38b09",
            measurementId: "G-LG8VN0EZB7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ===== Helpers for categories & beds =====
        function normalizeCategory(provider) {
            const raw = (
                provider['service Type'] ||
                provider.serviceType ||
                provider.careType ||
                provider.providerType ||
                ''
            ).toLowerCase();

            if (raw.includes('skilled')) return 'skilled-nursing';
            if (raw.includes('memory')) return 'memory-care';
            if (raw.includes('board')) return 'board-and-care-facilities';
            if (raw.includes('palliative')) return 'palliative';
            return 'hospice';
        }

        async function getBeds(providerId, providerData) {
            // Prefer subdoc: providers/{id}/beds/current
            try {
                const sub = await db
                    .collection('providers').doc(providerId)
                    .collection('beds').doc('current')
                    .get();
                if (sub.exists) {
                    const b = sub.data() || {};
                    return {
                        available: Number(b.available || 0),
                        occupied: Number(b.occupied || 0),
                        total: Number(b.total || 0),
                    };
                }
            } catch (e) {
                console.warn('beds/current read error', providerId, e);
            }
            // Fallback to root fields if present
            return {
                available: Number(providerData.available || 0),
                occupied: Number(providerData.occupied || 0),
                total: Number(providerData.total || 0),
            };
        }

        function upsertBedChip(card, category, beds) {
            const body = card.querySelector('.provider-body');
            if (!body) return;

            if (category !== 'skilled-nursing' || !beds || !Number.isFinite(beds.total)) {
                const existing = card.querySelector('.bed-availability');
                if (existing) existing.remove();
                return;
            }
            const isLow = (Number(beds.available) || 0) < 10;
            const html = `
              <div class="bed-availability ${isLow ? 'low' : ''}">
                <span class="bed-icon">üõèÔ∏è</span>
                <span>${Number(beds.available || 0)} / ${Number(beds.total || 0)} Beds Available</span>
              </div>
            `;
            const existing = card.querySelector('.bed-availability');
            if (existing) {
                existing.outerHTML = html;
            } else {
                body.insertAdjacentHTML('beforeend', html);
            }
        }

        function getCategoryIcon(category) {
            const icons = {
              'hospice': 'üè•',
              'skilled-nursing': 'üè®',
              'memory-care': 'üß†',
              'board-and-care-facilities': 'üè°',
              'palliative': 'üíô'
            };
            return icons[category] || 'üè•';
        }

        function getCategoryName(category) {
            const names = {
              'hospice': 'Hospice Care',
              'skilled-nursing': 'Skilled Nursing',
              'memory-care': 'Memory Care',
              'board-and-care-facilities': 'Board and Care Facilities',
              'palliative': 'Palliative Care'
            };
            return names[category] || 'Healthcare Provider';
        }

        function createProviderCard(provider, providerId, category, beds) {
            const card = document.createElement('div');
            card.className = 'provider-card';
            card.setAttribute('data-firebase-id', providerId);
            card.setAttribute('data-name', (provider.name || '').toLowerCase().replace(/\s+/g, '-'));
            card.setAttribute('data-location', provider.location || '');
            card.setAttribute('data-category', category);

            const desc = provider.description || 'Quality care services for your loved ones.';
            const logo = provider.logo || 'üè•';
            const contact = provider.contact;
            const email = provider.email;
            const website = provider.website;

            card.innerHTML = `
              <div class="provider-header">
                <div class="provider-logo">${logo}</div>
                <h3>${provider.name || 'Provider Name'}</h3>
                <div class="location">üìç ${provider.location || 'Location not specified'}</div>
              </div>
              <div class="provider-body">
                <span class="provider-type-badge">${getCategoryIcon(category)} ${getCategoryName(category)}</span>
                <div class="provider-description">${desc}</div>
                <div class="provider-info">
                  ${contact ? `
                  <div class="info-item">
                    <span class="info-icon">üë§</span>
                    <span><strong>Contact:</strong> ${contact}</span>
                  </div>` : ''}
                  ${email ? `
                  <div class="info-item">
                    <span class="info-icon">üìß</span>
                    <span><strong>Email:</strong> <a href="mailto:${email}" style="color: #00bcd4;">${email}</a></span>
                  </div>` : ''}
                  ${website ? `
                  <div class="info-item">
                    <span class="info-icon">üåê</span>
                    <span><strong>Website:</strong> <a href="${website}" target="_blank" style="color: #00bcd4;">${website}</a></span>
                  </div>` : ''}
                </div>
                <!-- bed chip inserted/updated by JS -->
                <div class="provider-actions">
                  <a href="#" class="btn btn-reviews">üìñ Read Reviews</a>
                  <a href="quick-signup.html?provider=${providerId}" class="btn btn-review">‚úçÔ∏è Leave a Review</a>
                </div>
              </div>
            `;

            upsertBedChip(card, category, beds);
            return card;
        }

        // ===== Main loader: cards + banner totals =====
        function loadFirestoreProviders() {
            db.collection('providers').onSnapshot(async (snapshot) => {
                let snfFacilities = 0;
                let snfBedsAvailable = 0;
                let snfBedsTotal = 0;

                const jobs = snapshot.docs.map(async (docSnap) => {
                    const provider = docSnap.data();
                    const providerId = docSnap.id;
                    const category = normalizeCategory(provider);

                    // fetch beds (subdoc or fallback)
                    const beds = await getBeds(providerId, provider);

                    // upsert card
                    let card = document.querySelector(`[data-firebase-id="${providerId}"]`);
                    if (!card) {
                        card = createProviderCard(provider, providerId, category, beds);
                        document.getElementById('providersGrid').appendChild(card);
                    } else {
                        card.setAttribute('data-category', category);
                        upsertBedChip(card, category, beds);
                    }

                    // accumulate banner totals for Skilled Nursing only
                    if (category === 'skilled-nursing') {
                        snfFacilities += 1;
                        snfBedsAvailable += Number(beds.available || 0);
                        snfBedsTotal += Number(beds.total || 0);
                    }
                });

                await Promise.all(jobs);

                // Update banner numbers (values update even if banner hidden)
                const elAvail = document.getElementById('bedsAvailableTotal');
                const elFacilities = document.getElementById('facilitiesCount');
                const elTotal = document.getElementById('bedsTotal');
                if (elAvail) elAvail.textContent = snfBedsAvailable;
                if (elFacilities) elFacilities.textContent = snfFacilities;
                if (elTotal) elTotal.textContent = snfBedsTotal;
            });
        }

        // Start
        window.addEventListener('DOMContentLoaded', loadFirestoreProviders);
    </script>
</body>
</html>
