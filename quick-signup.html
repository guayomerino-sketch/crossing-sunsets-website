<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leave a Review - Crossing Sunsetsâ„¢</title>
  <style>
    /* --- CORE STYLES --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(135deg, #0EA5E9 0%, #14B8A6 100%); /* Your Brand Blue/Teal */
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px; /* Slightly narrower for mobile focus */
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    .header { text-align: center; margin-bottom: 30px; }
    .logo { font-size: 28px; font-weight: bold; color: #0EA5E9; margin-bottom: 5px; }
    .subtitle { color: #7f8c8d; font-size: 16px; font-style: italic; }

    /* --- FORM FIELDS --- */
    .form-group { margin-bottom: 20px; }
    label { display: block; font-weight: 600; color: #34495e; margin-bottom: 6px; font-size: 14px; }
    .required { color: #e74c3c; margin-left: 3px; }
    .optional { color: #95a5a6; font-weight: normal; font-size: 12px; margin-left: 5px; }

    input[type="text"], input[type="email"], textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px; /* 16px prevents zoom on iPhone */
      transition: border-color 0.3s;
      font-family: inherit;
    }

    input:focus, textarea:focus { outline: none; border-color: #14B8A6; }
    textarea { min-height: 100px; resize: vertical; }

    /* --- THE LOTUS SYSTEM (Upgraded) --- */
    .lotus-section {
      background: #f0f9ff; /* Very light blue bg */
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 30px;
      border: 1px solid #bae6fd;
    }

    .lotus-title {
      font-size: 18px;
      font-weight: 700;
      color: #0369a1;
      margin-bottom: 5px;
      text-align: center;
    }

    .lotus-intro { color: #64748b; font-size: 14px; text-align: center; margin-bottom: 20px; }

    /* The Card Design */
    .lotus-item {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
    }

    /* THE BLOOM ANIMATION LOGIC */
    .lotus-flower-img {
      width: 50px;
      height: auto;
      margin-right: 15px;
      filter: grayscale(100%) opacity(0.5); /* Start Dead/Gray */
      transition: all 0.5s ease;
    }

    /* When Checked (Active) */
    .lotus-item.checked {
      border-color: #0EA5E9;
      background: #e0f2fe;
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
    }

    /* Animate the Image */
    .lotus-item.checked .lotus-flower-img {
      filter: grayscale(0%) opacity(1); /* Bloom to Color */
      transform: scale(1.15) rotate(5deg);
    }

    .lotus-header-row { display: flex; align-items: center; }
    .lotus-label-text { font-size: 16px; font-weight: 700; color: #334155; flex: 1; }
    .lotus-number { font-size: 12px; font-weight: 800; color: #0EA5E9; background: #e0f2fe; padding: 4px 8px; border-radius: 20px; }
    .lotus-description { color: #64748b; font-size: 13px; margin-left: 65px; margin-top: -5px; margin-bottom: 5px;}

    /* Explanation Box (Hidden until checked) */
    .explanation-box { margin-top: 10px; display: none; padding-left: 65px; }
    .lotus-item.checked .explanation-box { display: block; animation: fadeIn 0.4s; }
    .explanation-box textarea { min-height: 60px; font-size: 13px; }

    /* Hiding the raw checkbox */
    .lotus-checkbox { position: absolute; opacity: 0; pointer-events: none; }

    /* --- THE BADGE (New Feature) --- */
    #badge-display {
      display: none; /* Hidden by default */
      margin-top: 20px;
      margin-bottom: 20px;
      background: linear-gradient(145deg, #1e293b, #0f172a);
      color: white;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #fbbf24; /* Gold Border */
      text-align: center;
      animation: slideUp 0.6s ease-out;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .badge-img { width: 90px; margin-bottom: 10px; border-radius: 50%; box-shadow: 0 0 20px rgba(251, 191, 36, 0.4); border: 2px solid white; }
    .gold-text { color: #fbbf24; font-weight: 800; margin: 0; font-size: 1.2rem; letter-spacing: 1px; text-transform: uppercase; }

    /* --- SUBMIT BUTTON --- */
    .submit-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #0EA5E9 0%, #14B8A6 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 10px;
    }
    .submit-button:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(14, 184, 166, 0.4); }
    .submit-button:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }

    /* Messages */
    .success-message, .error-message { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; text-align: center;}
    .success-message { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
    .error-message { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Mobile adjustments */
    @media (max-width: 480px) {
      .container { padding: 20px; border-radius: 0; min-height: 100vh; }
      .lotus-flower-img { width: 40px; }
      .lotus-description, .explanation-box { margin-left: 0; margin-top: 10px; padding-left: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">Crossing Sunsetsâ„¢</div>
      <div class="subtitle">Share Your Experience</div>
    </div>

    <div id="successMessage" class="success-message">
      ðŸŽ‰ <strong>Thank you!</strong><br>Your Lotus Review has been submitted.
    </div>
    <div id="errorMessage" class="error-message"></div>

    <form id="reviewForm">
      <div class="form-group">
        <label>Your Name <span class="required">*</span></label>
        <input type="text" id="reviewerName" name="reviewerName" required placeholder="Enter your full name">
      </div>

      <div class="form-group">
        <label>Provider Name <span class="required">*</span></label>
        <input type="text" id="providerName" name="providerName" required placeholder="e.g., AllPeace Care Hospice">
      </div>

      <div class="form-group">
        <label>Email <span class="optional">(optional)</span></label>
        <input type="email" id="email" name="email" placeholder="your.email@example.com">
      </div>

      <div class="form-group">
        <label>Location <span class="optional">(optional)</span></label>
        <input type="text" id="location" name="location" placeholder="City, State">
      </div>

      <section class="lotus-section">
        <h2 class="lotus-title">The Perfect 4-Lotus Systemâ„¢ ðŸª·</h2>
        <p class="lotus-intro">Tap the lotuses to rate your experience.</p>

        <div id="compassionateItem" class="lotus-item">
          <input type="checkbox" id="compassionate" class="lotus-checkbox">
          <div class="lotus-header-row">
            <img src="lotus-logo.png" class="lotus-flower-img" alt="lotus">
            <div class="lotus-label-text">Compassionate</div>
            <div class="lotus-number">#1</div>
          </div>
          <div class="lotus-description">Kind, caring, and empathetic staff.</div>
          <div class="explanation-box">
            <textarea id="compassionateExplanation" placeholder="Tell us more about their compassion..."></textarea>
          </div>
        </div>

        <div id="responsiveItem" class="lotus-item">
          <input type="checkbox" id="responsive" class="lotus-checkbox">
          <div class="lotus-header-row">
            <img src="lotus-logo.png" class="lotus-flower-img" alt="lotus">
            <div class="lotus-label-text">Responsive</div>
            <div class="lotus-number">#2</div>
          </div>
          <div class="lotus-description">Quick to respond to needs and concerns.</div>
          <div class="explanation-box">
            <textarea id="responsiveExplanation" placeholder="Tell us more about their responsiveness..."></textarea>
          </div>
        </div>

        <div id="supportiveItem" class="lotus-item">
          <input type="checkbox" id="supportive" class="lotus-checkbox">
          <div class="lotus-header-row">
            <img src="lotus-logo.png" class="lotus-flower-img" alt="lotus">
            <div class="lotus-label-text">Supportive</div>
            <div class="lotus-number">#3</div>
          </div>
          <div class="lotus-description">Helpful guidance for family and patient.</div>
          <div class="explanation-box">
            <textarea id="supportiveExplanation" placeholder="How did they support you?"></textarea>
          </div>
        </div>

        <div id="professionalItem" class="lotus-item">
          <input type="checkbox" id="professional" class="lotus-checkbox">
          <div class="lotus-header-row">
            <img src="lotus-logo.png" class="lotus-flower-img" alt="lotus">
            <div class="lotus-label-text">Professional</div>
            <div class="lotus-number">#4</div>
          </div>
          <div class="lotus-description">Skilled, knowledgeable, and reliable.</div>
          <div class="explanation-box">
            <textarea id="professionalExplanation" placeholder="Tell us more about their professionalism..."></textarea>
          </div>
        </div>

        <div id="badge-display">
          <img src="lotus-badge.png" class="badge-img" alt="Gold Badge">
          <h3 class="gold-text">LOTUS CERTIFIED</h3>
          <p style="color: #cbd5e1; font-size: 13px; margin-top:5px;">This provider meets the Gold Standard of Care.</p>
        </div>

      </section>

      <div class="form-group">
        <label>Your Review <span class="required">*</span></label>
        <textarea id="reviewText" name="reviewText" required placeholder="Share your detailed experience with this provider..."></textarea>
      </div>

      <button type="submit" class="submit-button" id="submitButton">Submit Review</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyB410YcmXKj09W82ck6tZ2WYhyLdyZWtEQ",
      authDomain: "crossing-sunsets.firebaseapp.com",
      projectId: "crossing-sunsets",
      storageBucket: "crossing-sunsets.firebasestorage.app",
      messagingSenderId: "83761464492",
      appId: "1:83761464492:web:9e05d8af5a45fe1ff38b09",
      measurementId: "G-LG8VN0EZB7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const lotusIds = ['compassionate', 'responsive', 'supportive', 'professional'];

    lotusIds.forEach(id => {
      const checkbox = document.getElementById(id);
      const item = document.getElementById(id + 'Item');

      if (!checkbox || !item) return;

      // Click Card to Toggle
      item.addEventListener('click', (e) => {
        if (e.target.tagName === 'TEXTAREA') return; // Allow typing
        checkbox.checked = !checkbox.checked;
        checkbox.dispatchEvent(new Event('change'));
      });

      // Update Visuals & Badge
      checkbox.addEventListener('change', function () {
        if (this.checked) {
          item.classList.add('checked');
        } else {
          item.classList.remove('checked');
        }
        // TRIGGER BADGE CHECK
        checkBadgeStatus();
      });
    });

    // --- NEW FUNCTION: CHECK FOR BADGE ---
    function checkBadgeStatus() {
      let activeCount = 0;
      lotusIds.forEach(id => {
        if (document.getElementById(id).checked) activeCount++;
      });

      const badge = document.getElementById('badge-display');
      if (activeCount >= 3) {
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }

    // --- SUBMIT LOGIC ---
    document.getElementById('reviewForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const btn = document.getElementById('submitButton');
      const success = document.getElementById('successMessage');
      const errorDiv = document.getElementById('errorMessage');

      btn.disabled = true;
      btn.textContent = 'Submitting...';
      success.style.display = 'none';
      errorDiv.style.display = 'none';

      try {
        const reviewData = {
          reviewer_name: document.getElementById('reviewerName').value,
          provider_name: document.getElementById('providerName').value,
          email: document.getElementById('email').value || null,
          location: document.getElementById('location').value || null,
          review_text: document.getElementById('reviewText').value,
          lotus_compassionate: document.getElementById('compassionate').checked,
          lotus_compassionate_explanation: document.getElementById('compassionateExplanation').value || null,
          lotus_responsive: document.getElementById('responsive').checked,
          lotus_responsive_explanation: document.getElementById('responsiveExplanation').value || null,
          lotus_supportive: document.getElementById('supportive').checked,
          lotus_supportive_explanation: document.getElementById('supportiveExplanation').value || null,
          lotus_professional: document.getElementById('professional').checked,
          lotus_professional_explanation: document.getElementById('professionalExplanation').value || null,
          timestamp: serverTimestamp(),
          approved: false
        };

        // Calculate total count
        let totalLotus = 0;
        if (reviewData.lotus_compassionate) totalLotus++;
        if (reviewData.lotus_responsive) totalLotus++;
        if (reviewData.lotus_supportive) totalLotus++;
        if (reviewData.lotus_professional) totalLotus++;
        reviewData.total_lotus = totalLotus;

        await addDoc(collection(db, 'reviews'), reviewData);

        success.style.display = 'block';
        document.getElementById('reviewForm').reset();
        document.querySelectorAll('.lotus-item').forEach(i => i.classList.remove('checked'));
        document.getElementById('badge-display').style.display = 'none'; // Hide badge on reset
        window.scrollTo({ top: 0, behavior: 'smooth' });

      } catch (error) {
        console.error('Error:', error);
        errorDiv.textContent = 'âŒ Error: ' + error.message;
        errorDiv.style.display = 'block';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Submit Review';
      }
    });

    // --- URL PARAMS Logic ---
    const urlParams = new URLSearchParams(window.location.search);
    const providerParam = urlParams.get('provider');
    if (providerParam) {
      let providerName = providerParam;
      if (providerParam.toLowerCase() === 'allpeace') {
        providerName = 'AllPeace Care Hospice';
      } else {
        providerName = providerParam.replace(/-/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
      }
      document.getElementById('providerName').value = providerName;
    }
  </script>
</body>
</html>
